# Maintainer: DrZaius <lou[at]fakeoutdoorsman[dot]com>

pkgname=ffmpeg-git
pkgver=20110605
pkgrel=1
pkgdesc="A versatile tool to encode and decode a multitude of video and audio formats"
arch=('i686' 'x86_64')
url="http://ffmpeg.org/"
license=('GPL')
depends=()
makedepends=('git')
conflicts=('ffmpeg')
provides=("ffmpeg=$pkgver" "qt-faststart")
source=()
md5sums=()

_gitroot="git://git.videolan.org/ffmpeg"
_gitname="ffmpeg"

build() {
  cd $srcdir
  msg "Connecting to the GIT server...."
  
  if [[ -d $srcdir/$_gitname ]] ; then
    cd $_gitname
    git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot
  fi
  
  msg "GIT checkout done"
  msg "Starting make..."
  
  rm -rf $srcdir/$_gitname-build
  git clone $srcdir/$_gitname $srcdir/$_gitname-build
  
  cd $srcdir/$_gitname-build

  export LDFLAGS="${LDFLAGS//-Wl,--as-needed}"

  ./configure \
    --prefix=/usr \
--disable-avisynth           --disable-gpl                --disable-libnut             --disable-libvorbis \
--disable-gray               --disable-libopencore-amrnb  --disable-libvpx             --disable-runtime-cpudetect \
--disable-bzlib              --disable-hardcoded-tables   --disable-libopencore-amrwb  --disable-libx264            --disable-shared \
--disable-cross-compile      --disable-libopencv          --disable-libxavs            --disable-small \
--disable-debug             --disable-libcelt            --disable-libopenjpeg        --disable-libxvid            --disable-sram \
--disable-libdc1394          --disable-librtmp            --disable-memalign-hack      --disable-version3 \
--disable-libdirac           --disable-libschroedinger    --disable-mlib               --disable-w32threads \
--disable-libfaac            --disable-libspeex           --disable-muxer             --disable-x11grab \
--disable-extra-warnings     --disable-libfreetype        --disable-libtheora          --disable-nonfree            --disable-zlib \
--disable-filter            --disable-libgsm             --disable-libvo-aacenc       --disable-parser \
--disable-frei0r             --disable-libmp3lame         --disable-libvo-amrwbenc     --disable-pic \
--disable-aandct         --disable-avx            --disable-encoders       --disable-hwaccels       --disable-network        --disable-static \
--disable-altivec        --disable-bsf           --disable-everything     --disable-indev         --disable-optimizations  --disable-stripping \
--disable-amd3dnow       --disable-bsfs           --disable-fastdiv        --disable-indevs         --disable-outdev        --disable-swscale \
--disable-amd3dnowext    --disable-dct            --disable-ffmpeg         --disable-iwmmxt         --disable-outdevs        --disable-swscale-alpha \
--disable-armv5te        --disable-debug          --disable-ffplay         --disable-logging        --disable-parser        --disable-symver \
--disable-armv6          --disable-decoder       --disable-ffprobe        --disable-lpc            --disable-parsers        --disable-vaapi \
--disable-armv6t2        --disable-decoders       --disable-ffserver       --disable-mdct           --disable-postproc       --disable-vdpau \
--disable-armvfp         --disable-demuxer       --disable-fft            --disable-mmi            --disable-vis \
--disable-asm            --disable-demuxers       --disable-filter        --disable-mmx            --disable-protocols      --disable-yasm \
--disable-avcodec        --disable-devices        --disable-filters        --disable-mmx2           --disable-pthreads \
--disable-avdevice       --disable-doc            --disable-golomb         --disable-muxer         --disable-rdft \
--disable-avfilter       --disable-dxva2          --disable-huffman        --disable-muxers         --disable-sse \
--disable-avformat       --disable-encoder       --disable-hwaccel       --disable-neon           --disable-ssse3 \
 
  make
  make tools/qt-faststart
  make doc/ff{mpeg,play,probe,server}.1

  make DESTDIR="$pkgdir" install install-man || return 1
  install -D -m755 tools/qt-faststart "$pkgdir/usr/bin/qt-faststart" 
  
  rm -rf $srcdir/$_gitname-build
}
